<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Emperor News — 一覧ビュー</title>
<link rel="stylesheet" href="/assets/blog-shared.css">
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">E</div>
      <div>
        <h1>Emperor News</h1>
        <p>一覧ビュー / スマホ・タブレット・PC対応</p>
      </div>
    </div>
    <div class="actions">
      <a class="pill" href="/">トップ</a>
      <a class="pill primary" id="openLine" target="_blank" rel="noreferrer">公式LINEで読む</a>
      <a class="pill ghost" href="/blog-edit.html" data-requires-auth="true">記事を編集</a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="inline-chips">
        <div class="badge">新設</div>
        <div class="badge">レスポンシブ</div>
      </div>
      <h2>幅に合わせて表情を変える一覧ビュー</h2>
      <p>スマホでは縦にカードを並べ、タブレットはサムネイル横並び、PCではサイドバー付きの2カラムで統計とタグクラウドを固定。見やすさを保ちながら情報量を増やしました。</p>
      <div class="inline-chips">
        <span class="badge" id="metaInfo"></span>
        <span class="badge">LINE連携</span>
        <span class="badge">ローカル保存</span>
      </div>
    </section>

    <section class="grid-2">
      <article class="card">
        <h3>スマホビュー</h3>
        <p class="mobile-hint">1カラムでサムネイルを上、本文とタグを下に配置。タップしやすい余白を確保しました。</p>
      </article>
      <article class="card">
        <h3>タブレットビュー</h3>
        <p class="tablet-hint">サムネイル横並び＋行間拡大。768px以上で自動適用されます。</p>
      </article>
      <article class="card">
        <h3>PCビュー</h3>
        <p class="pc-hint">最大幅1200pxで2カラム＋サイドバーを固定。タグクラウドと統計を右側に表示します。</p>
      </article>
      <article class="card">
        <h3>共有と導線</h3>
        <p>各記事にLINE共有と記事リンクを配置。管理者リンクは認証が必要な場合のみ遷移します。</p>
      </article>
    </section>

    <section class="split-layout">
      <div class="list-shell">
        <div class="list-head">
          <div>
            <h3>最新の投稿</h3>
            <p class="muted">ローカル保存された記事を時系列順に一覧表示します。</p>
          </div>
          <div class="badge" id="countBadge"></div>
        </div>
        <div class="list card-layout" id="list"></div>
      </div>

      <aside class="stack" aria-label="サイド情報">
        <div class="panel">
          <div class="section-title" style="gap:6px;">
            <h3>ビューのステータス</h3>
            <span class="tiny">タブレット以上で右カラムに固定</span>
          </div>
          <div class="card-grid" id="stats"></div>
        </div>

        <div class="panel">
          <div class="section-title" style="gap:6px;">
            <h3>タグクラウド</h3>
            <span class="tiny">使用頻度順に表示</span>
          </div>
          <div class="tag-row" id="tagCloud"></div>
        </div>
      </aside>
    </section>
  </main>

  <script src="/assets/blog-data.js"></script>
  <script>
    const officialLinePage = "https://page.line.me/projecte_official";
    const adminSessionKey = "emperor_admin_token";
    const listEl = document.getElementById("list");
    const statsEl = document.getElementById("stats");
    const tagCloud = document.getElementById("tagCloud");
    const metaInfo = document.getElementById("metaInfo");
    const countBadge = document.getElementById("countBadge");

    function enforceAdminLinks() {
      const adminLinks = document.querySelectorAll('[data-requires-auth]');
      adminLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
          const authed = sessionStorage.getItem(adminSessionKey) === "active";
          if (authed) return;

          event.preventDefault();
          const rawTarget = link.getAttribute("href") || "/blog-edit.html";
          const normalized = rawTarget.startsWith("/") ? rawTarget : `/${rawTarget}`;
          const redirect = encodeURIComponent(normalized);
          location.href = `/admin.html?redirect=${redirect}`;
        });
      });
    }

    function formatRelative(index) {
      const base = Date.now() - index * 3_600_000 * 3;
      const diffHours = Math.max(1, Math.round((Date.now() - base) / 3_600_000));
      if (diffHours < 24) return `${diffHours}時間前`;
      const days = Math.round(diffHours / 24);
      return `${days}日前`;
    }

    function renderList(list) {
      listEl.innerHTML = "";
      list.forEach((item, idx) => {
        const articleUrl = `${location.origin}/blog-article.html?id=${idx}`;
        const shareUrl = BlogData.buildOfficialLineShare(articleUrl);
        const card = document.createElement("article");
        card.className = "list-card";
        const hasImage = Boolean(item.image);
        card.innerHTML = `
          ${hasImage ? `<img class="thumb" src="${item.image}" alt="${item.title}">` : `<div class="thumb fallback">NO IMAGE</div>`}
          <div class="stack" style="gap:12px;">
            <div class="inline-chips">
              <span class="badge">#${idx + 1}</span>
              <span class="badge">${formatRelative(idx)}に更新</span>
            </div>
            <h3 style="margin:0; font-size:18px; letter-spacing:0.01em;">${item.title}</h3>
            <p class="muted">${item.body}</p>
            <div class="meta">
              ${(item.tags || []).map(t => `<span class="tag">#${t}</span>`).join("") || '<span class="tag">#untagged</span>'}
            </div>
            <div class="actions">
              <a class="share line" href="${shareUrl}" target="_blank" rel="noreferrer">LINEで共有</a>
            </div>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function renderStats(list) {
      statsEl.innerHTML = "";
      const statItems = [
        { label: "記事数", value: `${list.length} 件` },
        { label: "スマホ/タブレット対応", value: "横2列⇔縦1列 自動切替" },
        { label: "LINE共有", value: "公式アカウントへ誘導" },
      ];
      statItems.forEach((item) => {
        const box = document.createElement("div");
        box.className = "card";
        box.innerHTML = `<h3>${item.label}</h3><p class="muted">${item.value}</p>`;
        statsEl.appendChild(box);
      });
    }

    function renderTags(list) {
      tagCloud.innerHTML = "";
      const counts = new Map();
      list.flatMap(item => item.tags || []).forEach(tag => {
        counts.set(tag, (counts.get(tag) || 0) + 1);
      });
      const entries = [...counts.entries()].sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        tagCloud.innerHTML = '<span class="badge">タグが未設定です</span>';
        return;
      }
      entries.forEach(([tag, count]) => {
        const chip = document.createElement("span");
        chip.className = "tag";
        chip.textContent = `#${tag} (${count})`;
        tagCloud.appendChild(chip);
      });
    }

    function renderMeta(count) {
      metaInfo.textContent = `公開中 ${count} 件`;
      countBadge.textContent = `${count} posts`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("openLine").href = officialLinePage;
      enforceAdminLinks();
      const articles = BlogData.loadArticles();
      renderList(articles);
      renderStats(articles);
      renderTags(articles);
      renderMeta(articles.length);
    });
  </script>
</body>
</html>
