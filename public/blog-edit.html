<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>記事編集 | Emperor News</title>
<link rel="stylesheet" href="/assets/base.css">
<body>
  <script>
    (function enforceAdminSession() {
      const SESSION_KEY = "emperor_admin_token";
      const authed = sessionStorage.getItem(SESSION_KEY) === "active";
      if (!authed) {
        const destination = encodeURIComponent(location.pathname + location.search + location.hash);
        window.location.replace(`/admin.html?redirect=${destination}`);
      }
    })();
  </script>

  <header class="site-header">
    <div class="brand">
      <div class="logo">E</div>
      <div>
        <h1>記事編集</h1>
        <p>公開ビューとは別の管理用編集ページ</p>
      </div>
    </div>
    <div class="actions">
      <a class="pill" href="/blog.html">公開一覧へ戻る</a>
      <a class="pill ghost" href="/admin.html">認証ページ</a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="inline-chips">
        <div class="badge" id="status">ログイン中</div>
        <div class="badge">スマホ〜PC対応</div>
      </div>
      <h2 style="margin:0">記事の新規追加・編集</h2>
      <p class="muted">タイトル・本文・タグ・カバー画像URLを入力して保存します。フォームやリストはすべてレスポンシブに配置しました。</p>
      <div class="actions" style="justify-content: space-between; align-items: flex-start;">
        <button class="secondary" id="newBtn">新規作成</button>
        <p class="tiny" id="helper">新しい記事を作成します。</p>
      </div>
    </section>

    <section class="panel stack">
      <form class="stack" id="editorForm">
        <div class="form-row">
          <label for="title" class="tiny">タイトル</label>
          <input id="title" name="title" required placeholder="記事タイトル">
        </div>
        <div class="form-row">
          <label for="body" class="tiny">本文 (複数段落は空行で区切ってください)</label>
          <textarea id="body" name="body" required placeholder="本文を入力"></textarea>
        </div>
        <div class="form-row">
          <label for="tags" class="tiny">タグ (カンマ区切り)</label>
          <input id="tags" name="tags" placeholder="iPhone, iPad, 公式LINE">
        </div>
        <div class="form-row">
          <label for="image" class="tiny">カバー画像URL</label>
          <input id="image" name="image" type="url" placeholder="https://example.com/cover.jpg">
        </div>
        <div class="form-row">
          <label class="tiny" for="imageFile">画像アップロード (jpg / png)</label>
          <div class="stack" style="gap:8px;">
            <input id="imageFile" type="file" accept="image/*">
            <div class="flex" style="align-items:flex-end; justify-content: space-between; gap:12px;">
              <div id="imagePreview" class="thumb fallback" style="width: 140px; height: auto; aspect-ratio: 4/3; display: grid; place-items: center;">No image</div>
              <div class="stack" style="align-items:flex-end; gap:6px;">
                <button class="secondary" type="button" id="clearImage">画像をクリア</button>
                <span class="tiny" id="imageStatus">URL入力かファイル選択でカバー画像を登録できます。</span>
              </div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="primary" type="submit" id="saveBtn">保存する</button>
        </div>
      </form>
    </section>

    <section class="panel">
      <div class="section-title">
        <h3>保存済みの記事</h3>
        <span class="tiny">ローカル保存された記事を編集または削除できます。</span>
      </div>
      <div class="stack" id="articleList"></div>
    </section>
  </main>

<script src="/assets/blog-data.js"></script>
<script>
  const SESSION_KEY = "emperor_admin_token";
  const form = document.getElementById("editorForm");
  const articleList = document.getElementById("articleList");
  const statusLabel = document.getElementById("status");
  const helper = document.getElementById("helper");
  const saveBtn = document.getElementById("saveBtn");
  const imageInput = document.getElementById("image");
  const imageFile = document.getElementById("imageFile");
  const imagePreview = document.getElementById("imagePreview");
  const imageStatus = document.getElementById("imageStatus");
  const clearImageBtn = document.getElementById("clearImage");
  let editingIdx = null;
  let imageData = "";

  function parseTags(input) {
    return input.split(/[\,\n]/).map(t => t.trim()).filter(Boolean);
  }

  function formatTags(tags) {
    return (tags || []).join(", ");
  }

  function setPreview(src) {
    imageData = src || "";
    if (!imageData) {
      imagePreview.classList.add("fallback");
      imagePreview.textContent = "No image";
      imagePreview.style.backgroundImage = "";
      imageStatus.textContent = "URL入力かファイル選択でカバー画像を登録できます。";
      return;
    }
    imagePreview.classList.remove("fallback");
    imagePreview.textContent = "";
    imagePreview.style.backgroundImage = `url(${imageData})`;
    imagePreview.style.backgroundSize = "cover";
    imagePreview.style.backgroundPosition = "center";
    imageStatus.textContent = "保存後、公開ビューでタップ拡大できます。";
  }

  function handleFileSelect(event) {
    const [file] = event.target.files || [];
    if (!file) return;
    if (!file.type.startsWith("image/")) {
      imageStatus.textContent = "画像ファイルを選択してください。";
      return;
    }
    if (file.size > 3 * 1024 * 1024) {
      imageStatus.textContent = "3MB以下の画像をアップロードしてください。";
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      imageInput.value = "";
      setPreview(reader.result);
    };
    reader.readAsDataURL(file);
  }

  function setSessionBadge() {
    const authed = sessionStorage.getItem(SESSION_KEY) === "active";
    statusLabel.textContent = authed ? "ログイン中: admin" : "未ログイン";
  }

  function renderList() {
    const articles = BlogData.loadArticles();
    articleList.innerHTML = "";
    if (!articles.length) {
      articleList.innerHTML = '<p class="muted">まだ記事がありません。フォームから追加してください。</p>';
      return;
    }

    articles.forEach((article, idx) => {
      const item = document.createElement("div");
      item.className = "card";
      item.innerHTML = `
        <div class="actions" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
          <div class="stack" style="gap:6px;">
            <div class="inline-chips">
              <span class="badge">ID ${idx}</span>
              <span class="badge">${(article.tags || []).length || 0} タグ</span>
            </div>
            <h3 style="margin:0;">${article.title || "無題の記事"}</h3>
            <p class="muted">${article.body?.slice(0, 80) || "本文がありません"}</p>
            <div class="tag-row">${(article.tags || []).map(tag => `<span class="tag">#${tag}</span>`).join("") || '<span class="tag">#untagged</span>'}</div>
          </div>
          <div class="stack" style="gap:6px; align-items:flex-end;">
            <button class="secondary" data-action="edit" data-idx="${idx}">編集</button>
            <button class="secondary" data-action="delete" data-idx="${idx}">削除</button>
          </div>
        </div>
      `;
      articleList.appendChild(item);
    });
  }

  function fillForm(article, idx) {
    document.getElementById("title").value = article?.title || "";
    document.getElementById("body").value = article?.body || "";
    document.getElementById("tags").value = formatTags(article?.tags);
    imageInput.value = article?.image || "";
    imageFile.value = "";
    setPreview(article?.image || "");
    editingIdx = Number.isInteger(idx) ? idx : null;
    helper.textContent = editingIdx === null ? "新しい記事を作成します。" : `ID ${editingIdx} を編集中です。`;
    saveBtn.textContent = editingIdx === null ? "保存する" : "更新する";
  }

  function handleSave(event) {
    event.preventDefault();
    const payload = {
      title: document.getElementById("title").value.trim(),
      body: document.getElementById("body").value.trim(),
      tags: parseTags(document.getElementById("tags").value),
      image: imageData || imageInput.value.trim(),
    };

    BlogData.upsertArticle(payload, editingIdx);
    fillForm({}, null);
    renderList();
    alert("記事を保存しました");
  }

  function handleListClick(event) {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const idx = parseInt(target.dataset.idx, 10);
    if (!Number.isFinite(idx)) return;

    if (target.dataset.action === "edit") {
      const { article } = BlogData.findArticle(idx);
      fillForm(article, idx);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    if (target.dataset.action === "delete") {
      if (confirm("この記事を削除しますか？")) {
        BlogData.deleteArticle(idx);
        renderList();
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    setSessionBadge();
    renderList();
    fillForm({}, null);
  });

  form.addEventListener("submit", handleSave);
  articleList.addEventListener("click", handleListClick);
  imageFile.addEventListener("change", handleFileSelect);
  imageInput.addEventListener("input", (event) => setPreview(event.target.value.trim()));
  clearImageBtn.addEventListener("click", () => {
    imageInput.value = "";
    imageFile.value = "";
    setPreview("");
  });
  document.getElementById("newBtn").addEventListener("click", () => fillForm({}, null));
</script>
</body>
</html>
