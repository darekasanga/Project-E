<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emperor News ‚Äì Draw & Chat</title>
<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<style>
  :root {
    --bg:#0b0c10; --panel:#0f141a; --text:#eaecef; --border:#30363d; --accent:#1f6feb;
  }
  *{box-sizing:border-box}
  body {
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial;
    display:flex; height:100vh; overflow:hidden;
  }
  #drawPanel, #chatPanel {
    flex:1; padding:16px; display:flex; flex-direction:column;
    background:var(--panel); border:1px solid var(--border);
  }
  #divider {
    width:70px; background:var(--bg); display:flex;
    align-items:center; justify-content:center;
  }
  button, input, textarea { font:inherit; }
  .btn { background:var(--accent); color:#fff; border:0;
         border-radius:10px; padding:8px 14px; cursor:pointer; }
  .ghost { background:#2d333b; }
  #toolbar { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:10px; }
  #drawCanvas {
    flex:1; background:#fff; border-radius:10px; border:2px solid var(--border);
    touch-action:none; max-width:100%;
  }
  #chatLog {
    flex:1; overflow-y:auto; background:#0e1116;
    border:1px solid var(--border); border-radius:10px;
    padding:10px; white-space:pre-wrap;
  }
  #chatInput { width:100%; padding:8px; border-radius:8px;
    border:1px solid var(--border); background:#0e1116; color:var(--text); }
  #sendBtn { margin-top:6px; }
  @media (max-width:900px){
    body { flex-direction:column; }
    #divider{height:70px;width:100%;}
  }
</style>
</head>
<body>

<!-- DRAW PANEL -->
<section id="drawPanel">
  <h2>üñåÔ∏è Draw Field</h2>
  <div id="toolbar">
    <input type="color" id="color" value="#000000">
    <input type="range" id="size" min="1" max="24" value="4">
    <button id="clear" class="ghost btn">Clear</button>
    <button id="save" class="ghost btn">Save</button>
  </div>
  <canvas id="drawCanvas" width="800" height="600"></canvas>
  <div style="margin-top:10px;display:flex;gap:8px;">
    <button id="describe" class="btn ghost">Describe</button>
    <button id="generate" class="btn">Generate</button>
  </div>
</section>

<!-- DIVIDER -->
<div id="divider">
  <button id="update" class="btn" title="Send drawing to chat">‚ñ∂</button>
</div>

<!-- CHAT PANEL -->
<section id="chatPanel">
  <h2>üí¨ Chat Window</h2>
  <div id="chatLog"></div>
  <textarea id="chatInput" placeholder="Write a comment or question..."></textarea>
  <button id="sendBtn" class="btn">Comment</button>
</section>

<script>
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
let drawing=false;
const color=document.getElementById('color'), size=document.getElementById('size');
function pos(e){const r=canvas.getBoundingClientRect(),t=e.touches?e.touches[0]:e;
  return{x:t.clientX-r.left,y:t.clientY-r.top};}
function start(e){drawing=true;ctx.beginPath();const p=pos(e);ctx.moveTo(p.x,p.y);}
function move(e){if(!drawing)return;const p=pos(e);
  ctx.strokeStyle=color.value;ctx.lineWidth=+size.value;ctx.lineCap='round';
  ctx.lineTo(p.x,p.y);ctx.stroke();}
function end(){drawing=false;}
canvas.addEventListener('mousedown',start);canvas.addEventListener('mousemove',move);
window.addEventListener('mouseup',end);
canvas.addEventListener('touchstart',e=>{e.preventDefault();start(e)});
canvas.addEventListener('touchmove',e=>{e.preventDefault();move(e)});
canvas.addEventListener('touchend',end);

document.getElementById('clear').onclick=()=>ctx.clearRect(0,0,canvas.width,canvas.height);
document.getElementById('save').onclick=()=>{
  const a=document.createElement('a');a.href=canvas.toDataURL('image/png');
  a.download='sketch.png';a.click();
};

// Chat logic
const chatLog=document.getElementById('chatLog');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');
const updateBtn=document.getElementById('update');
const messages=[];
function append(role,text){
  const who=role==='user'?'üë§ You':'ü§ñ AI';
  const div=document.createElement('div');
  div.innerHTML=`<strong>${who}:</strong> ${text}`;
  chatLog.appendChild(div);
  chatLog.scrollTop=chatLog.scrollHeight;
}
async function chatSend(text){
  append('user',text);
  try{
    const r=await fetch('/api/chat',{method:'POST',
      body:JSON.stringify({messages:[{role:'user',content:text}],
      system:'You are a drawing assistant helping explain sketches.'})});
    const d=await r.json();
    append('assistant',d.reply||'No reply');
  }catch(e){append('assistant','Error: '+e.message);}
}
sendBtn.onclick=()=>{const t=chatInput.value.trim();if(t){chatInput.value='';chatSend(t);}};

// Update (send current drawing to AI caption)
updateBtn.onclick=async ()=>{
  append('user','(Sending drawing...)');
  const img=canvas.toDataURL('image/png');
  const r=await fetch('/api/caption',{method:'POST',body:JSON.stringify({imageBase64:img})});
  const d=await r.json();
  const desc=d.caption||'No caption';
  append('assistant','Sketch description: '+desc);
};

</script>
</body>
</html>
