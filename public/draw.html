<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Draw ‚Äì Emperor News</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    :root{--bg:#0b0c10;--card:#0f141a;--text:#eaecef;--muted:#9aa4af;--border:#30363d;--brand:#1f6feb;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{max-width:980px;margin:auto;padding:20px}
    h1{margin:0 0 8px}
    p{margin:.25rem 0}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.ghost{background:#2d333b}
    input[type="color"],input[type="range"],button,textarea{font:inherit}
    #toolbar{margin:12px 0}
    canvas{background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.25);touch-action:none;max-width:100%;height:auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    textarea{width:100%;min-height:72px;border-radius:10px;border:1px solid var(--border);background:#0e1116;color:var(--text);padding:10px}
    #status,#genStatus{color:var(--muted)}
    img.preview{max-width:min(100%,420px);border-radius:10px;border:1px solid var(--border)}
    hr{border:0;border-top:1px solid var(--border);opacity:.5;margin:24px 0}
    @media (max-width:600px){ header{padding:14px} }
  </style>
</head>
<body>
  <header>
    <h1>üé® AI Draw</h1>
    <p>Sketch, describe with AI, generate images, and chat ‚Äî all on <strong>emperor.news</strong>.</p>

    <!-- Drawing tools -->
    <div id="toolbar" class="row">
      <label>Color <input type="color" id="color" value="#000000"></label>
      <label>Size <input type="range" id="size" min="1" max="24" value="4"></label>
      <button class="btn ghost" id="clear">Clear</button>
      <button class="btn ghost" id="save">Save PNG</button>
      <button class="btn" id="caption">üß† Describe Sketch</button>
    </div>

    <canvas id="c" width="900" height="560" aria-label="Drawing canvas"></canvas>
    <p id="status"></p>

    <!-- Text-to-image -->
    <h3 style="margin-top:18px">üñåÔ∏è Generate Image from Prompt</h3>
    <div class="card">
      <textarea id="prompt" placeholder="e.g., a serene temple on a hill at sunset, minimalist watercolor"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="gen">Generate</button>
        <span id="genStatus"></span>
      </div>
      <div id="genOut" style="margin-top:10px"></div>
    </div>

    <!-- ChatGPT panel -->
    <hr>
    <h3>üí¨ ChatGPT</h3>
    <div id="chat" class="card">
      <div id="chatLog" style="min-height:140px;white-space:pre-wrap"></div>
      <div class="row" style="margin-top:10px">
        <input id="chatInput" type="text" placeholder="Ask anything‚Ä¶" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);background:#0e1116;color:var(--text)">
        <button id="chatSend" class="btn">Send</button>
        <button id="sendCanvas" class="btn ghost" title="Send current canvas as context">Send Canvas</button>
      </div>
    </div>
  </header>

  <script>
    // ---------- Drawing ----------
    const c = document.getElementById('c'), x = c.getContext('2d');
    let drawing = false;
    const color = document.getElementById('color'), size = document.getElementById('size');
    const statusEl = document.getElementById('status');

    function pos(e){
      const r = c.getBoundingClientRect();
      const t = e.touches ? e.touches[0] : e;
      return { x: t.clientX - r.left, y: t.clientY - r.top };
    }
    function start(e){ drawing = true; x.beginPath(); const p=pos(e); x.moveTo(p.x,p.y); }
    function move(e){
      if(!drawing) return;
      const p=pos(e);
      x.strokeStyle = color.value;
      x.lineWidth = +size.value;
      x.lineCap = 'round';
      x.lineTo(p.x,p.y); x.stroke();
    }
    function end(){ drawing = false; }

    c.addEventListener('mousedown', start);
    c.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);
    c.addEventListener('touchstart', e=>{e.preventDefault();start(e)});
    c.addEventListener('touchmove',  e=>{e.preventDefault();move(e)});
    c.addEventListener('touchend',   end);

    document.getElementById('clear').onclick = () => x.clearRect(0,0,c.width,c.height);
    document.getElementById('save').onclick  = () => {
      const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='sketch.png'; a.click();
    };

    // ---------- Caption (vision) ----------
    document.getElementById('caption').onclick = async () => {
      statusEl.textContent = "Describing‚Ä¶";
      try {
        const imageBase64 = c.toDataURL('image/png'); // data URL
        const r = await fetch('/api/caption', { method:'POST', body: JSON.stringify({ imageBase64 }) });
        const data = await r.json();
        statusEl.textContent = data.caption ? `üìù ${data.caption}` : 'No description';
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      }
    };

    // ---------- Text-to-Image ----------
    document.getElementById('gen').onclick = async () => {
      const prompt = document.getElementById('prompt').value.trim();
      if(!prompt){ document.getElementById('genStatus').textContent='Enter a prompt.'; return; }
      document.getElementById('genStatus').textContent='Generating‚Ä¶';
      try{
        const r = await fetch('/api/generate-image', { method:'POST', body: JSON.stringify({ prompt }) });
        const data = await r.json();
        const out = document.getElementById('genOut');
        out.innerHTML = '';
        if(data.imageBase64){
          const img = new Image(); img.className='preview';
          img.src = 'data:image/png;base64,' + data.imageBase64;
          out.appendChild(img);
          document.getElementById('genStatus').textContent='Done';
        } else {
          document.getElementById('genStatus').textContent='No image returned';
        }
      }catch(e){
        document.getElementById('genStatus').textContent='Error: '+e.message;
      }
    };

    // ---------- Chat ----------
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const sendCanvasBtn = document.getElementById('sendCanvas');
    const history = [];

    function append(role, text){
      const who = role==='user' ? 'üë§ You' : role==='assistant' ? 'ü§ñ ChatGPT' : 'üìù';
      const div = document.createElement('div');
      div.style.margin='6px 0';
      div.innerHTML = `<strong>${who}:</strong> ${escapeHtml(text)}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}

    async function sendChat(text, imageDataUrl){
      history.push({ role:'user', content: text });
      append('user', text);
      append('system', '‚Ä¶thinking‚Ä¶');
      try{
        const r = await fetch('/api/chat', {
          method:'POST',
          body: JSON.stringify({
            system: 'You are a concise, friendly assistant for emperor.news.',
            messages: history
          })
        });
        const data = await r.json();
        chatLog.lastChild.remove();
        const reply = data.reply || 'No reply.';
        history.push({ role:'assistant', content: reply });
        append('assistant', reply);
      }catch(e){
        chatLog.lastChild.remove();
        append('assistant','Error: ' + e.message);
      }
    }

    chatSend.onclick = () => {
      const text = chatInput.value.trim();
      if(!text) return;
      chatInput.value = '';
      sendChat(text);
    };
    chatInput.addEventListener('keydown', e => (e.key === 'Enter') && chatSend.click());

    // Optional: send the current canvas as a message (described by the model via caption endpoint first)
    sendCanvasBtn.onclick = async () => {
      try{
        const imageBase64 = c.toDataURL('image/png');
        // Reuse caption to summarize the image before chatting
        const r = await fetch('/api/caption', { method:'POST', body: JSON.stringify({ imageBase64 }) });
        const data = await r.json();
        const desc = data.caption ? `Describe and improve this sketch: ${data.caption}` : 'Describe and improve this sketch.';
        sendChat(desc);
      }catch(e){
        append('assistant','Error sending canvas: ' + e.message);
      }
    };
  </script>
</body>
</html>
