<!doctype html>
<html lang="en">
<head>
  // ‚ñ∂ Update (caption)
const r = await fetch('/api/caption', {
  method:'POST',
  headers:{ 'Content-Type':'application/json' },
  body: JSON.stringify({ imageBase64 })
});

// Chat
const r = await fetch('/api/chat', {
  method:'POST',
  headers:{ 'Content-Type':'application/json' },
  body: JSON.stringify({
    system: 'You are a concise assistant‚Ä¶',
    messages: [{ role:'user', content: text }]
  })
});
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emperor News ‚Äì Draw & Chat</title>
<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<style>
  :root{
    --bg:#0b0c10;--panel:#0f141a;--text:#eaecef;--muted:#9aa4af;--border:#30363d;--brand:#1f6feb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial;
    display:flex;gap:0;overflow:hidden;
  }
  /* Panels */
  #drawPanel,#chatPanel{
    flex:1;min-width:0;display:flex;flex-direction:column;
    padding:16px;background:var(--panel);border:1px solid var(--border);
  }
  #divider{
    width:70px;min-width:70px;background:var(--bg);
    display:flex;align-items:center;justify-content:center;border-inline:1px solid var(--border);
  }

  h2{margin:0 0 10px}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  button,input,textarea{font:inherit}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:8px 14px;cursor:pointer}
  .ghost{background:#2d333b}
  label{font-size:.9rem;color:var(--muted)}

  /* Canvas area (responsive, crisp) */
  #toolbar{margin-bottom:10px}
  #drawCanvasWrap{
    flex:1;min-height:240px;display:flex;align-items:stretch;
  }
  #drawCanvas{
    width:100%;height:100%;
    background:#fff;border-radius:10px;border:2px solid var(--border);
    touch-action:none;display:block;
  }

  /* Chat */
  #chatLog{
    flex:1;min-height:120px;overflow:auto;background:#0e1116;
    border:1px solid var(--border);border-radius:10px;padding:10px;white-space:pre-wrap
  }
  #chatInput{
    width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
    background:#0e1116;color:var(--text)
  }
  #status{color:var(--muted);margin:.25rem 0}

  @media (max-width:900px){
    body{flex-direction:column}
    #divider{width:100%;min-width:100%;height:70px}
  }
</style>
</head>
<body>

<!-- LEFT: DRAW PANEL -->
<section id="drawPanel">
  <h2>üñåÔ∏è Draw Field</h2>

  <div id="toolbar" class="row">
    <label>Color <input type="color" id="color" value="#000000"></label>
    <label>Size <input type="range" id="size" min="1" max="24" value="4"></label>
    <button id="clear" class="btn ghost">Clear</button>
    <button id="save"  class="btn ghost">Save</button>
  </div>

  <div id="drawCanvasWrap">
    <canvas id="drawCanvas"></canvas>
  </div>

  <p id="status"></p>
</section>

<!-- MIDDLE: UPDATE BUTTON -->
<div id="divider" title="Send drawing to chat">
  <button id="update" class="btn">‚ñ∂ Update</button>
</div>

<!-- RIGHT: CHAT PANEL -->
<section id="chatPanel">
  <h2>üí¨ Chat Window</h2>
  <div id="chatLog"></div>
  <textarea id="chatInput" placeholder="Write a comment or question‚Ä¶"></textarea>
  <div class="row" style="margin-top:8px">
    <button id="sendBtn" class="btn">Comment</button>
  </div>
</section>

<script>
/* ========== Responsive, HiDPI-correct Canvas Setup ========== */
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

let drawing=false, dpr=1, scaleX=1, scaleY=1;

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  dpr = window.devicePixelRatio || 1;

  // Backing size in physical pixels
  canvas.width  = Math.max(1, Math.round(rect.width  * dpr));
  canvas.height = Math.max(1, Math.round(rect.height * dpr));

  // Reset and scale the context to keep strokes crisp
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);

  // Ratios (CSS‚Üípixel); also useful if we ever need them
  scaleX = canvas.width  / rect.width;
  scaleY = canvas.height / rect.height;
}
new ResizeObserver(resizeCanvas).observe(canvas.parentElement);
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 50));
window.addEventListener('load', resizeCanvas);

/* Pointer to canvas coords (accounts for DPR & scroll) */
function getPos(e){
  const rect = canvas.getBoundingClientRect();
  const p = e.touches ? e.touches[0] : e;
  // Convert from CSS pixels to drawing space (divide by dpr because we scaled context)
  return { x: (p.clientX - rect.left), y: (p.clientY - rect.top) };
}

/* Drawing handlers */
const color = document.getElementById('color');
const size  = document.getElementById('size');

function start(e){ drawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); }
function move(e){
  if(!drawing) return;
  const p=getPos(e);
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.strokeStyle=color.value; ctx.lineWidth=+size.value;
  ctx.lineTo(p.x,p.y); ctx.stroke();
}
function end(){ drawing=false; }

canvas.addEventListener('mousedown', start);
canvas.addEventListener('mousemove', move);
window.addEventListener('mouseup', end);

canvas.addEventListener('touchstart', e=>{ e.preventDefault(); start(e); }, {passive:false});
canvas.addEventListener('touchmove',  e=>{ e.preventDefault(); move(e);  }, {passive:false});
canvas.addEventListener('touchend',   end);

/* Clear / Save */
document.getElementById('clear').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
document.getElementById('save').onclick  = () => {
  const a=document.createElement('a');
  a.href = canvas.toDataURL('image/png'); // exports at full backing res
  a.download='sketch.png'; a.click();
};

/* ========== Chat & Update Wiring ========== */
const chatLog   = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const sendBtn   = document.getElementById('sendBtn');
const updateBtn = document.getElementById('update');
const statusEl  = document.getElementById('status');

function append(role, text){
  const who = role==='user' ? 'üë§ You' : role==='assistant' ? 'ü§ñ AI' : 'üìù';
  const div = document.createElement('div');
  div.style.margin='6px 0';
  div.innerHTML = `<strong>${who}:</strong> ${escapeHtml(text)}`;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}
function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}

async function sendChat(text){
  append('user', text);
  try{
    const r = await fetch('/api/chat', {
      method:'POST',
      body: JSON.stringify({
        system: 'You are a concise assistant helping describe and improve sketches.',
        messages: [{ role:'user', content: text }]
      })
    });
    const data = await r.json();
    append('assistant', data.reply || 'No reply.');
  }catch(e){
    append('assistant', 'Error: ' + e.message);
  }
}
sendBtn.onclick = () => {
  const t = chatInput.value.trim();
  if(!t) return;
  chatInput.value=''; sendChat(t);
};
chatInput.addEventListener('keydown', e => (e.key==='Enter') && sendBtn.click());

/* ‚ñ∂ Update: describe current canvas and show in chat */
updateBtn.onclick = async () => {
  statusEl.textContent = 'Describing sketch‚Ä¶';
  try{
    const imageBase64 = canvas.toDataURL('image/png'); // data URL
    const r = await fetch('/api/caption', { method:'POST', body: JSON.stringify({ imageBase64 }) });
    const data = await r.json();
    const desc = (data && data.caption) ? data.caption : 'No description.';
    statusEl.textContent = 'Done';
    append('assistant', 'Sketch description: ' + desc);
  }catch(e){
    statusEl.textContent = 'Error: ' + e.message;
  }
};
</script>
</body>
</html>
