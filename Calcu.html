<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>延長・預り保育 計算（完成版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --accent:#2563eb;
      --muted:#f4f4f5;
      --border:#d4d4d8;
      --text:#111827;
      --subtext:#4b5563;
      --weekend-bg:#fee2e2;
      --weekday-bg:#eef2ff;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#fff;color:var(--text);line-height:1.5;
      touch-action: manipulation;
      overscroll-behavior: none;
    }

    header{
      background:linear-gradient(120deg,var(--accent),#38bdf8);
      color:#fff;padding:14px 20px;
      display:flex;align-items:center;gap:12px;
      position:sticky;top:0;z-index:50;
      box-shadow:0 2px 12px rgba(0,0,0,.12);
    }
    .logo-circle{
      width:40px;height:40px;border-radius:50%;
      background:#fff;color:#2563eb;font-weight:800;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,.18);
    }
    header h1{margin:0;font-size:20px;font-weight:700;}
    header p{margin:2px 0 0;font-size:12px;opacity:.9;}
    .header-info{display:flex;flex-direction:column;gap:6px;flex:1;min-width:0;}
    .header-flow{
      display:inline-flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.26);
      color:#fff;border-radius:999px;
      padding:6px 12px;font-size:12px;font-weight:800;
      width:fit-content;
      box-shadow:0 4px 14px rgba(15,23,42,.16);
    }
    .header-actions{
      display:flex;align-items:center;gap:8px;
      margin-left:auto;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .header-chip{
      border:none;border-radius:999px;
      padding:8px 12px;font-weight:800;cursor:pointer;
      background:rgba(255,255,255,.18);color:#fff;
      border:1px solid rgba(255,255,255,.3);
      transition:background .2s,border-color .2s;
    }
    .header-chip:hover{background:rgba(255,255,255,.26);border-color:rgba(255,255,255,.36);}
    .header-chip.primary{background:#0ea5e9;border-color:#38bdf8;}
    .header-chip.ghost{background:rgba(255,255,255,.12);}
    .sidebar-toggle{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      background:#0ea5e9;color:#fff;
      font-weight:800;font-size:12px;cursor:pointer;
    }
    .pill.attend{border-color:#0891b2;color:#155e75;}
    .pill.absent{border-color:#b91c1c;color:#7f1d1d;}
    .pill.closed{border-color:#ea580c;color:#9a3412;}
    .dc-tags{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;min-height:18px;}
    .tag{
      font-size:9px;border-radius:999px;padding:1px 6px;
      border:1px solid #d1d5db;color:#6b7280;background:transparent;
      font-weight:700;
    }
    .tag.on{background:#cffafe;border-color:#06b6d4;color:#155e75;}
    .tag.az{background:#fef9c3;border-color:#f59e0b;color:#92400e;}

    main{
      padding:16px;
      max-width:1400px;width:100%;
      margin:0 auto 60px;
      display:grid;grid-template-columns:minmax(260px,320px) minmax(0,1fr);
      gap:16px;align-items:flex-start;
    }
    body.sidebar-collapsed main{grid-template-columns:1fr;}
    body.sidebar-collapsed .sidebar{display:none;}
    .content{min-width:0;}

    .panel{
      background:#fff;border:1px solid #e5e7eb;border-radius:12px;
      padding:14px 14px;box-shadow:0 6px 20px rgba(15,23,42,.06);
      margin-bottom:16px;
    }
    .panel h2{margin:0 0 10px;font-size:16px;font-weight:800;}
    label{display:block;font-size:13px;font-weight:700;color:var(--subtext);margin-bottom:6px;}
    input[type="file"],input[type="number"],input[type="text"],button{
      font:inherit;
    }
    input[type="file"],input[type="number"],input[type="text"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:10px;background:#fff;
    }
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.16);}

    .row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .row > div{flex:1;min-width:120px;}

    button{
      border:none;border-radius:10px;
      padding:10px 12px;font-weight:800;cursor:pointer;
      background:var(--accent);color:#fff;
    }
    button.small{
      padding:4px 10px;font-size:11px;border-radius:999px;
      background:#f3f4f6;color:#111827;border:1px solid #d1d5db;
      font-weight:700;
    }
    button.small.primary{
      background:var(--accent);color:#fff;border-color:var(--accent);
    }
    button.small.warn{
      background:#f97316;color:#fff;border-color:#f97316;
    }
    button:disabled{opacity:.6;cursor:not-allowed;}
    .muted{color:var(--subtext);font-size:12px;}
    .date-range{font-weight:800;margin-bottom:6px;}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;}
    th,td{border:1px solid #e5e7eb;padding:6px 8px;font-size:12px;vertical-align:top;}
    th{background:var(--muted);font-weight:800;}
    caption{text-align:left;font-weight:800;margin-bottom:6px;}

    .tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
    .tab-button{
      padding:8px 14px;border-radius:999px;border:1px solid #d1d5db;
      background:#f9fafb;color:#374151;font-weight:700;font-size:13px;cursor:pointer;
    }
    .tab-button.active{background:var(--accent);border-color:var(--accent);color:#fff;}
    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    /* 日カード */
    th.col-day,td.col-day{width:118px;padding:0;border:none;}
    .daycard{
      width:108px;min-height:148px;
      border:1px solid #e5e7eb;border-radius:10px;
      margin:0 auto;background:#fff;
      position:relative;padding:6px 6px 10px;
      display:flex;flex-direction:column;gap:6px;align-items:center;
    }
    .daycard::before{
      content:"";position:absolute;left:0;top:0;height:100%;width:5px;
      border-radius:10px 0 0 10px;background:#3b82f6;
    }
    .daycard.type-1gou::before{background:#34d399;}
    .daycard.type-short::before{background:#fb923c;}
    .daycard.type-standard::before{background:#3b82f6;}
    .daycard.status-absent::before{background:#ef4444;}
    .daycard.status-closed::before{background:#9ca3af;}

    .dc-head{display:flex;align-items:center;gap:6px;}
    .dc-week{font-size:11px;color:#6b7280;font-weight:800;}
    .dc-date{font-size:18px;font-weight:900;}
    .pill{
      font-size:11px;border-radius:999px;padding:2px 8px;
      border:1px solid #d1d5db;background:#fff;color:#374151;font-weight:700;
    }
    .pill.attend{border-color:#16a34a;color:#166534;background:#dcfce7;}
    .pill.absent{border-color:#b91c1c;color:#7f1d1d;background:#fee2e2;}
    .pill.closed{border-color:#ea580c;color:#9a3412;background:#ffedd5;}
    .dc-tags{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;min-height:18px;}
    .tag{
      font-size:9px;border-radius:999px;padding:1px 6px;
      border:1px solid #d1d5db;color:#6b7280;background:transparent;
      font-weight:700;
    }
    .tag.on{background:#dbeafe;border-color:#2563eb;color:#1d4ed8;}
    .tag.az{background:#fef9c3;border-color:#f59e0b;color:#92400e;}
1
    .time-input{
      width:78px;font-size:12px;padding:4px 6px;border-radius:8px;border:1px solid #d1d5db;
    }
    .diff{font-size:11px;color:#6b7280;margin-top:2px;}

    .type-toggle{display:flex;flex-direction:column;gap:4px;align-items:center;}
    .typeBtn{width:82px;white-space:normal;line-height:1.15;}
    .typeBtn.active{background:var(--accent);border-color:var(--accent);color:#fff;}

    .vac-btn{
      width:100%;border-radius:10px;
      border:1px dashed #d1d5db;background:#f8fafc;color:#374151;
      padding:6px 8px;font-weight:800;font-size:11px;
    }
    .vac-btn.active{background:#fef3c7;border-color:#f59e0b;color:#92400e;}

    .az-chip{
      width:100%;border:1px dashed #f59e0b;border-radius:10px;
      padding:4px 6px;background:#fffbeb;
      display:flex;flex-direction:column;gap:2px;align-items:center;
      font-size:11px;font-weight:700;color:#92400e;
    }
    .az-chip.off{border-color:#d4d4d8;background:#f8fafc;color:#6b7280;}
    .az-chip .fee{font-size:12px;font-weight:900;}
    .auto-note{font-size:10px;color:#6b7280;}

    .day-actions{width:100%;display:flex;flex-direction:column;gap:4px;}
    .day-chip{
      width:100%;border-radius:10px;border:1px solid #d1d5db;
      background:#f9fafb;color:#374151;font-weight:800;font-size:11px;
      padding:6px 8px;cursor:pointer;
      transition:background .2s,border-color .2s,color .2s;
    }
    .day-chip.primary{background:#dcfce7;border-color:#16a34a;color:#166534;}
    .day-chip.ghost{background:#f9fafb;}
    .day-chip:hover{background:#eef2ff;border-color:#c7d2fe;}

    .time-cell{display:flex;flex-direction:column;gap:6px;align-items:flex-start;}
    .time-input-row{display:flex;align-items:center;gap:8px;}
    .time-buttons{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:4px;width:100%;}
    .time-btn{
      padding:4px 8px;border-radius:10px;border:none;font-weight:800;font-size:11px;cursor:pointer;
      color:#fff;display:flex;align-items:center;justify-content:center;
    }
    .time-btn.minus5,.time-btn.plus5{background:#3b82f6;}
    .time-btn.minus1,.time-btn.plus1{background:#22c55e;}
    .time-btn:hover{opacity:.92;}

    .row-selected td{outline:2px solid #38bdf8;outline-offset:-2px;}
    .detail-filters{
      display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .detail-filters .filter{
      display:flex;flex-direction:column;gap:4px;
      min-width:140px;
    }
    .detail-filters select{
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      font-size:13px;
    }
    .detail-table{width:100%;}
    .detail-table th.col-type,.detail-table td.col-type{width:94px;}
  </style>
</head>
<body>
  <header>
    <div class="logo-circle">園</div>
    <div class="header-info">
      <div>
        <h1>延長・預り保育 計算</h1>
        <p>延長：30分200円（3,000円上限）／ 預り：定額（要件反映済）</p>
      </div>
      <div class="header-flow">① CSV取込 → ②【標準/短/1号】区分変更 → ③ コドモンに転記</div>
    </div>
    <div class="header-actions">
      <button type="button" class="header-chip ghost">出力</button>
      <button type="button" id="toggleSidebar" class="header-chip primary sidebar-toggle">表示設定</button>
      <button type="button" class="header-chip ghost">変更履歴</button>
    </div>
  </header>

  <main>
    <div class="sidebar" id="sidebar">
      <section class="panel">
        <h2>入力</h2>
        <label for="csvFile">登降園実績表（月ごと・CSV）</label>
        <input id="csvFile" type="file" accept=".csv,text/csv" />
        <div style="margin-top:10px;">
          <button id="calculate" type="button">計算する</button>
        </div>
        <p class="muted" style="margin:10px 0 0;">
          期待列：日付 / 出欠 / 名前 / 園 / 所属 / 登園時刻 / 降園時刻
        </p>
      </section>

      <section class="panel">
        <h2>設定</h2>
        <div class="row">
          <div>
            <label>登園バッファ（分）</label>
            <input id="arriveBuffer" type="number" min="0" step="1" value="0">
            <div class="muted">早朝登園の判定を緩めるため、登園時刻に加算</div>
          </div>
          <div>
            <label>降園バッファ（分）</label>
            <input id="leaveBuffer" type="number" min="0" step="1" value="0">
            <div class="muted">遅い降園の判定を緩めるため、降園時刻から減算</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>預り判定時刻（通常日）</label>
            <input id="azJudge" type="text" value="15:00">
            <div class="muted">例：15:00（この時刻まで園にいれば預り500円）</div>
          </div>
          <div>
            <label>延長バッファ（分）</label>
            <input id="extBuffer" type="number" min="0" step="1" value="0">
            <div class="muted">延長の判定に使う（朝夕共通）</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button id="saveSettings" class="small primary" type="button">設定を保存</button>
          <button id="resetSettings" class="small" type="button">設定リセット</button>
        </div>
      </section>

      <section class="panel">
        <h2>メモ</h2>
        <div class="muted">
          - 基本区分が1号認定で 8:30〜16:30 をカバー → 自動で「1号＋預り保育（500円）」<br>
          - 日カードの「長期休暇」ボタンはタップで循環（OFF→1日(1,000円)→午前(500円)→午後(500円)→OFF）<br>
          - 長期休暇を付けた日は出欠に関わらず「登園」扱いで集計
        </div>
      </section>
    </div>

    <div class="content">
      <section class="panel">
        <h2>月別・人別サマリー</h2>
        <div id="summaryContainer" class="muted">CSVを読み込んで計算すると表示されます。</div>
      </section>

      <section class="panel">
        <h2>日次明細</h2>
        <div id="dateRangeLabel" class="date-range"></div>
        <div id="detailContainer" class="muted">計算後に表示されます。</div>
      </section>
    </div>
  </main>

<script>
/* =========================
   状態・設定
function parseTimeToMinutes(t){
  if(!t) return null;
  const m = String(t).trim().match(/^(\d{1,2}):(\d{2})$/);
  if(!m) return null;
  const h=Number(m[1]), mi=Number(m[2]);
  if(Number.isNaN(h)||Number.isNaN(mi) || mi<0||mi>59) return null;
  return h*60+mi;
}

function minutesToTime(mins){
  if(mins==null) return "";
  const h=String(Math.floor(mins/60)).padStart(2,"0");
  const m=String(mins%60).padStart(2,"0");
  return `${h}:${m}`;
}

function sanitizeHHMM(v){
  const s = String(v||"").trim();
  if(s==="") return "";
  const m = s.match(/^(\d{1,2})[:：](\d{2})$/);
  if(!m) return "";
  const hh = String(Math.min(23, Math.max(0, Number(m[1])))).padStart(2,"0");
  const mmN = Number(m[2]);
  if(Number.isNaN(mmN) || mmN<0 || mmN>59) return "";
  const mm = String(mmN).padStart(2,"0");
  return `${hh}:${mm}`;
}

function formatDiff(v){
  const n = Number(v||0);
  if(!n) return "±0分";
  return (n>0?`+${n}`:`-${Math.abs(n)}`)+"分";
}

function uniq(arr){ return Array.from(new Set(arr)); }
function str(v){ return String(v??"").trim(); }
function esc(v){ return String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
function clampInt(v,min,max){
  const n = Number(v);
  if(Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, Math.floor(n)));
}

function cssEscape(v){
  if(typeof CSS !== "undefined" && CSS.escape){
    return CSS.escape(v);
  }
  return String(v??"").replace(/"/g,'\\"');
}

function makeRecordKey({rawDate, school, clazz, name}){
  return [rawDate||"", school||"", clazz||"", name||""].join("|");
}

/* =========================
   永続化
========================= */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(DEFAULT_SETTINGS);
    const s = JSON.parse(raw);
    return {
      ...structuredClone(DEFAULT_SETTINGS),
      ...s,
      overridesByKey: s.overridesByKey || {}
    };
  }catch{
    return structuredClone(DEFAULT_SETTINGS);
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function applySidebarState(){
  document.body.classList.toggle("sidebar-collapsed", !!state.sidebarCollapsed);
  toggleSidebarBtn.textContent = state.sidebarCollapsed ? "表示設定をひらく" : "表示設定をとじる";
}

function applySettingsToInputs(){
  arriveBufferEl.value = String(state.arriveBuffer ?? 0);
  leaveBufferEl.value  = String(state.leaveBuffer ?? 0);
  extBufferEl.value    = String(state.extBuffer ?? 0);
  azJudgeEl.value      = String(state.azJudge ?? "15:00");
}
</script>
</body>
</html>